<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Libro para colorear de Montserrat</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f5f5; }
    .container { max-width: 500px; margin: auto; padding: 1rem; }
    .prompt-area { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    #prompt { flex: 1; padding: 0.5rem; font-size: 1rem; }
    #voice-btn { padding: 0.5rem 1rem; font-size: 1rem; }
    #generate-btn { padding: 0.5rem 1rem; font-size: 1rem; }
    #canvas-area { position: relative; margin-bottom: 1rem; }
    #coloring-canvas { border: 2px solid #ccc; background: #fff; touch-action: none; }
    .palette-ios {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .palette-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      margin-bottom: 1rem;
    }
    .color-swatch {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 2px solid #eee;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: border 0.15s, transform 0.15s;
    }
    .color-swatch.selected {
      border: 3px solid #007aff;
      transform: scale(1.12);
    }
    .active-color-box {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: 3px solid #007aff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      background: #fff;
      margin-bottom: 0.5rem;
      transition: background 0.15s;
    }
    .tools { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .tool-btn { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; border: 1px solid #ccc; background: #333; border-radius: 6px; }
    .tool-btn.selected { background: #e0e0e0; border-color: #333; }
    #undo-btn { background: #ffe082; border-color: #ffb300; }
    #eraser { background: #f48fb1; border-color: #c2185b; }
    /* Spinner styles */
    #spinner {
      display: none;
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      z-index: 2;
    }
    .lds-spinner {
      color: #007aff;
      display: inline-block;
      position: relative;
      width: 64px;
      height: 64px;
    }
    .lds-spinner div {
      transform-origin: 32px 32px;
      animation: lds-spinner 1.2s linear infinite;
    }
    .lds-spinner div:after {
      content: " ";
      display: block;
      position: absolute;
      top: 3px;
      left: 29px;
      width: 6px;
      height: 18px;
      border-radius: 20%;
      background: #007aff;
    }
    .lds-spinner div:nth-child(1) { transform: rotate(0deg); animation-delay: -1.1s;}
    .lds-spinner div:nth-child(2) { transform: rotate(30deg); animation-delay: -1s;}
    .lds-spinner div:nth-child(3) { transform: rotate(60deg); animation-delay: -0.9s;}
    .lds-spinner div:nth-child(4) { transform: rotate(90deg); animation-delay: -0.8s;}
    .lds-spinner div:nth-child(5) { transform: rotate(120deg); animation-delay: -0.7s;}
    .lds-spinner div:nth-child(6) { transform: rotate(150deg); animation-delay: -0.6s;}
    .lds-spinner div:nth-child(7) { transform: rotate(180deg); animation-delay: -0.5s;}
    .lds-spinner div:nth-child(8) { transform: rotate(210deg); animation-delay: -0.4s;}
    .lds-spinner div:nth-child(9) { transform: rotate(240deg); animation-delay: -0.3s;}
    .lds-spinner div:nth-child(10) { transform: rotate(270deg); animation-delay: -0.2s;}
    .lds-spinner div:nth-child(11) { transform: rotate(300deg); animation-delay: -0.1s;}
    .lds-spinner div:nth-child(12) { transform: rotate(330deg); animation-delay: 0s;}
    @keyframes lds-spinner {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="prompt-area">
      <input type="text" id="prompt" placeholder="Describe lo que quieres colorear...">
      <button id="voice-btn" title="Hablar">游꿗</button>
      <button id="generate-btn">Generar imagen</button>
    </div>
    <div id="canvas-area">
      <canvas id="coloring-canvas" width="500" height="400"></canvas>
      <div id="spinner">
        <div class="lds-spinner">
          <div></div><div></div><div></div><div></div>
          <div></div><div></div><div></div><div></div>
          <div></div><div></div><div></div><div></div>
        </div>
      </div>
    </div>
    <div class="palette-ios">
      <div class="palette-grid" id="palette-grid"></div>
      <div class="active-color-box" id="active-color-box"></div>
    </div>
    <div class="tools">
      <div class="tool-btn tool-circle" id="pencil-thin" title="L치piz fino">
        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#333;vertical-align:middle;">
          <span style="display:block;width:3px;height:3px;margin:9.5px auto;background:#fff;border-radius:50%;"></span>
        </span>
      </div>
      <div class="tool-btn tool-circle" id="pencil-medium" title="L치piz medio">
        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#333;vertical-align:middle;">
          <span style="display:block;width:6px;height:6px;margin:8px auto;background:#fff;border-radius:50%;"></span>
        </span>
      </div>
      <div class="tool-btn tool-circle" id="pencil-thick" title="L치piz grueso">
        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#333;vertical-align:middle;">
          <span style="display:block;width:12px;height:12px;margin:5px auto;background:#fff;border-radius:50%;"></span>
        </span>
      </div>
      <div class="tool-btn tool-circle" id="pencil-xthick" title="L치piz extra grueso">
        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#333;vertical-align:middle;">
          <span style="display:block;width:18px;height:18px;margin:2px auto;background:#fff;border-radius:50%;"></span>
        </span>
      </div>
      <div class="tool-btn tool-circle" id="pencil-xxthick" title="L치piz s칰per grueso">
        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#333;vertical-align:middle;">
          <span style="display:block;width:24px;height:24px;margin:-1px auto;background:#fff;border-radius:50%;"></span>
        </span>
      </div>
      <div class="tool-btn tool-circle" id="pencil-xxxthick" title="L치piz mega grueso">
        <span style="display:inline-block;width:22px;height:22px;border-radius:50%;background:#333;vertical-align:middle;">
          <span style="display:block;width:32px;height:32px;margin:-5px -4px;background:#fff;border-radius:50%;"></span>
        </span>
      </div>
      <button class="tool-btn" id="eraser">Borrador</button>
      <button class="tool-btn" id="undo-btn">Undo</button>
    </div>
  </div>
  <script>
    // --- PWA Service Worker ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // --- Paleta de 64 colores en grilla estilo iOS ---
    const paletteColors = [];
    for (let r = 0; r < 4; r++)
      for (let g = 0; g < 4; g++)
        for (let b = 0; b < 4; b++)
          paletteColors.push(`rgb(${r*85},${g*85},${b*85})`);

    const paletteGrid = document.getElementById('palette-grid');
    const activeColorBox = document.getElementById('active-color-box');
    let currentColor = paletteColors[0];

    paletteColors.forEach((color, i) => {
      const swatch = document.createElement('div');
      swatch.className = 'color-swatch';
      swatch.style.background = color;
      swatch.dataset.color = color;
      swatch.addEventListener('click', () => {
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
        swatch.classList.add('selected');
        currentColor = color;
        activeColorBox.style.background = color;
        isErasing = false;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('selected'));
      });
      if (i === 0) swatch.classList.add('selected');
      paletteGrid.appendChild(swatch);
    });
    // Inicializa el color activo
    activeColorBox.style.background = paletteColors[0];
    currentColor = paletteColors[0];

    // --- Herramientas ---
    let currentWidth = 6;
    let isErasing = false;
    let lastEraserTap = 0;

    document.getElementById('pencil-thin').onclick = function() {
      currentWidth = 3; isErasing = false;
      selectTool(this);
    };
    document.getElementById('pencil-medium').onclick = function() {
      currentWidth = 6; isErasing = false;
      selectTool(this);
    };
    document.getElementById('pencil-thick').onclick = function() {
      currentWidth = 12; isErasing = false;
      selectTool(this);
    };
    document.getElementById('pencil-xthick').onclick = function() {
      currentWidth = 18; isErasing = false;
      selectTool(this);
    };
    document.getElementById('pencil-xxthick').onclick = function() {
      currentWidth = 24; isErasing = false;
      selectTool(this);
    };
    document.getElementById('pencil-xxxthick').onclick = function() {
      currentWidth = 32; isErasing = false;
      selectTool(this);
    };
    document.getElementById('eraser').onclick = function(e) {
      isErasing = true;
      selectTool(this);
      // Doble tap para borrar todo
      const now = Date.now();
      if (now - lastEraserTap < 400) {
        clearCanvas();
      }
      lastEraserTap = now;
    };
    document.getElementById('undo-btn').onclick = function() {
      undo();
    };
    function selectTool(btn) {
      document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }
    document.getElementById('pencil-medium').classList.add('selected');

    // --- Canvas para colorear ---
    const canvas = document.getElementById('coloring-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false, lastX = 0, lastY = 0;

    // --- Undo stack ---
    let undoStack = [];
    function saveState() {
      undoStack.push(canvas.toDataURL());
      if (undoStack.length > 50) undoStack.shift();
    }
    function undo() {
      if (undoStack.length > 0) {
        const img = new Image();
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
        img.src = undoStack.pop();
      }
    }
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      undoStack = [];
    }

    function startDraw(x, y) {
      saveState();
      drawing = true; lastX = x; lastY = y;
    }
    function draw(x, y) {
      if (!drawing) return;
      ctx.strokeStyle = isErasing ? "#fff" : currentColor;
      ctx.lineWidth = currentWidth;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x; lastY = y;
    }
    function endDraw() { drawing = false; }

    // Eventos t치ctiles y de mouse
    canvas.addEventListener('pointerdown', e => {
      const rect = canvas.getBoundingClientRect();
      startDraw(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener('pointermove', e => {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      draw(e.clientX - rect.left, e.clientY - rect.top);
    });
    canvas.addEventListener('pointerup', endDraw);
    canvas.addEventListener('pointerleave', endDraw);

    // --- Generaci칩n de imagen para colorear ---
    async function generateImage(prompt) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      undoStack = [];
      document.getElementById('spinner').style.display = 'block';

      if (!prompt) {
        alert("Por favor ingresa un prompt.");
        document.getElementById('spinner').style.display = 'none';
        return;
      }

      // Endpoint y API Key de Gemini 2.5 Flash Image Preview (Nano Banana)
      const PROXY_URL = "https://proxy.jlquintero.workers.dev/"; 
      try {
        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt + " black and white, thick lines, coloring page" }] }],
            generationConfig: { temperature: 0.4 }
          })
        });

        const data = await response.json();
        const base64Image = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
        if (base64Image) {
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            document.getElementById('spinner').style.display = 'none';
          };
          img.src = "data:image/png;base64," + base64Image;
        } else {
          const errorMsg = JSON.stringify(data, null, 2);
          alert("No se pudo generar la imagen. Intenta de nuevo.\n\n" + errorMsg);
          console.error("Error de generaci칩n:", data);
          document.getElementById('spinner').style.display = 'none';
        }
      } catch (error) {
        alert("Error al generar la imagen.\n\n" + (error?.message || error));
        console.error("Error de red o ejecuci칩n:", error);
        document.getElementById('spinner').style.display = 'none';
      }
    }

    document.getElementById('generate-btn').onclick = () => {
      const prompt = document.getElementById('prompt').value.trim();
      if (prompt) generateImage(prompt);
    };

    // --- Voz a texto ---
    document.getElementById('voice-btn').onclick = () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Tu navegador no soporta reconocimiento de voz.');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.onresult = function(event) {
        document.getElementById('prompt').value = event.results[0][0].transcript;
      };
      recognition.start();
    };

    // No dibuja imagen inicial
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  </script>
</body>
</html>
